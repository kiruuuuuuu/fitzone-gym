{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}{{ action }} Membership Plan{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
            <i class="fas fa-id-card mr-3 text-blue-600"></i>{{ action }} Membership Plan
        </h1>
        <p class="text-gray-600 text-lg">Create or edit a subscription pricing plan for your gym members</p>
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <form method="POST">
            {% csrf_token %}
            
            <div class="mb-6">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                    Plan Name *
                </label>
                <input type="text" id="name" name="name" required
                       value="{% if plan %}{{ plan.name }}{% endif %}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="mb-6">
                <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-rupee-sign mr-2"></i>Price (â‚¹) *
                </label>
                <input type="number" id="price" name="price" step="0.01" min="0" required
                       value="{% if plan %}{{ plan.price }}{% endif %}"
                       placeholder="Enter price in rupees"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="text-xs text-gray-500 mt-1">Enter the price for this membership plan (one-time payment for the selected duration)</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-list-check mr-2"></i>Plan Features *
                </label>
                <div id="features-container" class="space-y-3 mb-3">
                    {% for feature in existing_features %}
                    <div class="feature-item flex gap-2 items-start p-3 border border-gray-300 rounded-lg bg-gray-50">
                        <input type="hidden" name="feature_text[]" value="{{ feature.feature_text }}" class="feature-text">
                        <input type="hidden" name="feature_icon[]" value="{{ feature.icon }}" class="feature-icon">
                        <input type="hidden" name="feature_highlighted[]" value="{% if feature.is_highlighted %}{{ forloop.counter0 }}{% endif %}" class="feature-highlighted">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                                <input type="text" value="{{ feature.feature_text }}" placeholder="Feature description" 
                                       class="feature-text-input flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <input type="text" value="{{ feature.icon }}" placeholder="fa-check" 
                                       class="feature-icon-input w-32 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                       title="Font Awesome icon class (e.g., fa-check, fa-dumbbell)">
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="checkbox" {% if feature.is_highlighted %}checked{% endif %} 
                                           class="feature-highlight-checkbox">
                                    <span>Highlight</span>
                                </label>
                                <button type="button" onclick="removeFeature(this)" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="feature-item flex gap-2 items-start p-3 border border-gray-300 rounded-lg bg-gray-50">
                        <input type="hidden" name="feature_text[]" value="" class="feature-text">
                        <input type="hidden" name="feature_icon[]" value="" class="feature-icon">
                        <input type="hidden" name="feature_highlighted[]" value="" class="feature-highlighted">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                                <input type="text" placeholder="Feature description" 
                                       class="feature-text-input flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <input type="text" placeholder="fa-check" 
                                       class="feature-icon-input w-32 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                       title="Font Awesome icon class (e.g., fa-check, fa-dumbbell)">
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="checkbox" class="feature-highlight-checkbox">
                                    <span>Highlight</span>
                                </label>
                                <button type="button" onclick="removeFeature(this)" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" onclick="addFeature()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition text-sm">
                    <i class="fas fa-plus mr-2"></i>Add Feature
                </button>
                <p class="text-xs text-gray-500 mt-2">
                    <strong>Tip:</strong> Use Font Awesome icon classes (e.g., "fa-check", "fa-dumbbell", "fa-users"). 
                    Check "Highlight" for important features that will be shown prominently.
                </p>
                <!-- Keep old textarea for backward compatibility (hidden) -->
                <textarea id="features" name="features" rows="1" class="hidden">{% if plan %}{{ plan.features }}{% endif %}</textarea>
            </div>
            
            <script>
            function addFeature() {
                const container = document.getElementById('features-container');
                const newFeature = document.createElement('div');
                newFeature.className = 'feature-item flex gap-2 items-start p-3 border border-gray-300 rounded-lg bg-gray-50';
                newFeature.innerHTML = `
                    <input type="hidden" name="feature_text[]" value="" class="feature-text">
                    <input type="hidden" name="feature_icon[]" value="" class="feature-icon">
                    <input type="hidden" name="feature_highlighted[]" value="" class="feature-highlighted">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                            <input type="text" placeholder="Feature description" 
                                   class="feature-text-input flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <input type="text" placeholder="fa-check" 
                                   class="feature-icon-input w-32 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                   title="Font Awesome icon class">
                            <label class="flex items-center gap-1 text-sm">
                                <input type="checkbox" class="feature-highlight-checkbox">
                                <span>Highlight</span>
                            </label>
                            <button type="button" onclick="removeFeature(this)" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(newFeature);
                attachFeatureListeners(newFeature);
            }
            
            function removeFeature(button) {
                const container = document.getElementById('features-container');
                if (container.children.length > 1) {
                    button.closest('.feature-item').remove();
                    updateFeatureOrder();
                } else {
                    alert('At least one feature is required.');
                }
            }
            
            function attachFeatureListeners(featureItem) {
                const textInput = featureItem.querySelector('.feature-text-input');
                const iconInput = featureItem.querySelector('.feature-icon-input');
                const hiddenText = featureItem.querySelector('.feature-text');
                const hiddenIcon = featureItem.querySelector('.feature-icon');
                const highlightCheckbox = featureItem.querySelector('.feature-highlight-checkbox');
                const hiddenHighlight = featureItem.querySelector('.feature-highlighted');
                
                textInput.addEventListener('input', () => {
                    hiddenText.value = textInput.value;
                });
                
                iconInput.addEventListener('input', () => {
                    hiddenIcon.value = iconInput.value;
                });
                
                highlightCheckbox.addEventListener('change', () => {
                    const index = Array.from(document.querySelectorAll('.feature-item')).indexOf(featureItem);
                    hiddenHighlight.value = highlightCheckbox.checked ? index : '';
                    updateFeatureOrder();
                });
            }
            
            function updateFeatureOrder() {
                document.querySelectorAll('.feature-item').forEach((item, index) => {
                    const hiddenHighlight = item.querySelector('.feature-highlighted');
                    const checkbox = item.querySelector('.feature-highlight-checkbox');
                    if (checkbox.checked) {
                        hiddenHighlight.value = index;
                    } else {
                        hiddenHighlight.value = '';
                    }
                });
            }
            
            // Attach listeners to existing features
            document.querySelectorAll('.feature-item').forEach(item => {
                attachFeatureListeners(item);
            });
            
            // Update hidden fields before form submit
            document.querySelector('form').addEventListener('submit', function(e) {
                document.querySelectorAll('.feature-item').forEach((item, index) => {
                    const textInput = item.querySelector('.feature-text-input');
                    const iconInput = item.querySelector('.feature-icon-input');
                    const hiddenText = item.querySelector('.feature-text');
                    const hiddenIcon = item.querySelector('.feature-icon');
                    
                    hiddenText.value = textInput.value;
                    hiddenIcon.value = iconInput.value;
                });
            });
            
            function selectAllWorkouts() {
                const checkboxes = document.querySelectorAll('input[name="included_workouts"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            }
            </script>
            
            <div class="mb-6">
                <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>Subscription Duration *
                </label>
                <select id="duration" name="duration" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="trial" {% if plan and plan.duration == 'trial' %}selected{% endif %}>Free Trial (1 week)</option>
                    <option value="1_week" {% if plan and plan.duration == '1_week' %}selected{% endif %}>1 Week</option>
                    <option value="1_month" {% if plan and plan.duration == '1_month' or not plan %}selected{% endif %}>1 Month</option>
                    <option value="3_months" {% if plan and plan.duration == '3_months' %}selected{% endif %}>3 Months</option>
                    <option value="6_months" {% if plan and plan.duration == '6_months' %}selected{% endif %}>6 Months</option>
                    <option value="12_months" {% if plan and plan.duration == '12_months' %}selected{% endif %}>12 Months</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Select the subscription duration for this plan</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-dumbbell mr-2"></i>Included Workouts
                </label>
                <div class="border border-gray-300 rounded-lg p-4 max-h-96 overflow-y-auto bg-gray-50">
                    <div class="mb-3 flex items-center justify-between">
                        <p class="text-xs text-gray-600">Select workouts that will be included with this membership plan. Users with this plan will have access to these workouts.</p>
                        <button type="button" onclick="selectAllWorkouts()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                            Select All
                        </button>
                    </div>
                    <div class="space-y-2">
                        {% regroup all_workouts by category as workouts_by_category %}
                        {% for category_group in workouts_by_category %}
                        <div class="mb-4">
                            <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-tag mr-2 text-blue-600"></i>{{ category_group.grouper|title }}
                            </h5>
                            <div class="space-y-1 ml-4">
                                {% for workout in category_group.list %}
                                <div class="flex items-center p-2 hover:bg-white rounded border border-transparent hover:border-gray-200 transition">
                                    <input type="checkbox" id="workout_{{ workout.id }}" name="included_workouts" value="{{ workout.id }}"
                                           {% if plan and workout in plan.included_workouts.all %}checked{% endif %}
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="workout_{{ workout.id }}" class="ml-2 flex-1 cursor-pointer">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-sm">{{ workout.title }}</span>
                                            <div class="flex items-center gap-2 text-xs">
                                                <span class="px-2 py-1 rounded {% if workout.is_free %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                                    {% if workout.is_free %}<i class="fas fa-unlock mr-1"></i>Free{% else %}<i class="fas fa-crown mr-1"></i>Premium{% endif %}
                                                </span>
                                                <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded">Level {{ workout.difficulty_level }}</span>
                                                <span class="text-gray-500"><i class="fas fa-layer-group mr-1"></i>{{ workout.sets }} sets</span>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-sm">No workouts available. <a href="{% url 'staff:workout_create' %}" class="text-blue-600 hover:underline">Create a workout first</a>.</p>
                        {% endfor %}
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i><strong>Note:</strong> Premium workouts will only be accessible to users with an active subscription to this plan. Free workouts are accessible to everyone.
                </p>
            </div>
            
            <div class="mb-6">
                <div class="flex items-center">
                    <input type="checkbox" id="is_active" name="is_active" 
                           {% if plan and plan.is_active or not plan %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="is_active" class="ml-2 block text-sm text-gray-900">
                        <i class="fas fa-check-circle mr-2 text-green-600"></i>Is Active (Plan is available for signup)
                    </label>
                </div>
                <p class="text-xs text-gray-500 mt-1 ml-6">Only active plans will be visible to users on the pricing page</p>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                    {{ action }} Plan
                </button>
                <a href="{% url 'staff:plan_list' %}" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300 transition text-center">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

